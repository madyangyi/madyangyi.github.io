# 软件需求

垃圾识别APP作为本公司垃圾识别项目的一部分，安装在项目定制地专用一体机中。

一体机暂定屏幕尺寸为15.6寸，分辨率为1920*1080px，采用安卓系统。

软件主要由宣传页和识别页两个功能模块构成。宣传页主要用于播放广告轮播图；识别页用于垃圾识别的图像输入、识别和结果现实。

## 1 系统修改和APP通用功能

* APP安装在项目定制地专用一体机中。前期调试使用安卓平板电脑，后期调试采用指定的安卓开发板连接屏幕、摄像头等模块。
* 开机自动启动APP，启动后联网校对并设置系统时间。
* 在指定时间自动开机/关机，具体时间由配置文件指定。
* APP更新采用静默安装，全程无需用户手动操作。
* APP拥有访问摄像头、读写文件、修改系统设置、读取地理位置、网络连接等权限，无需在使用过程中动态申请。

## 2 宣传页

宣传页可分为2个状态：正常和停用。

* 正常状态如图：
* <img src=page/宣传页_正常.png width=400px />
* 停用状态如图：
* <img src=page/宣传页_停用.png width=400px />

### 2.1 状态切换逻辑

* 触发时机：
  * 每当进入宣传页时，触发一次判断。
  * 处于宣传页中时，每隔1分钟触发一次判断。

* 判断内容：
  * 配置文件是否强制禁用设备
  * 当前时间是否处于设备关机的时间段内（具体时间由配置文件给出）。

* 判断结果：
  * 上述判断内容中任一项为真，则设为禁用状态，否则设为正常状态。

### 2.2 页面元素

#### 2.2.1 状态栏

* 状态栏位于页面顶部，固定不动。

* 左侧显示当前时间，包含年月日时分，格式为“yyyy年mm月dd日 hh:mm”。时间为二十四小时制。

* 右侧依次显示当前设备ID，地理位置（精确到市），Wifi/4G信号强度。
  * ID文字读取配置文件，配置文件中未规定的，显示“UNKNOWN”。
  * 地理位置先读取GPS信号，无GPS信号的读取配置文件，配置文件中未填写的，显示文字“未知”。
  * 音量图标暂无功能。
  * Wifi/4G信号强度：若采用wifi联网，则显示wifi信号强度，否则显示4G信号强度。

#### 2.2.2 轮播图

* 图片数量：最多设置8张图片，最少设置1张图片。轮播范围根据图片文件数量动态调整。
* 滚动参数：方向为纵向。滚动时，新图片从下往上推入，旧图片从下往上推出。
* 滚动间隔：8秒，该间隔时间由配置文件指定。
* 滚动速度：动效长度为1秒。
* 指示点：轮播图右侧居中显示与图片数量一致的小圆指示点。当前图片的指示点为黑色，非当前图片的为灰色。

#### 2.2.3 识别按钮

* 按钮状态：具有正常、按下两种状态。
* 点击逻辑：跳转到识别页。

#### 2.2.4 服务条款文字

* 文字内容：“按下按钮表明您知晓并同意《相关服务条款》”
* 文字样式：“《相关服务条款》”为超链接样式，其余为提示文字样式。
* 点击逻辑：按下，点击后弹出服务条款弹窗。示意图如下：
* <img src=page/宣传页_服务.png width=400px />

#### 2.2.5 服务条款页面

* 文字内容：读取相关文件，或显示指定网页。文字横向自动换行。如果文字长度超过容器长度，则显示垂直滚动条。
* 关闭逻辑：以下三种方式均可关闭该弹窗。
  * 点击关闭按钮。
  * 点击四周暗色遮罩部分。
  * 等待设定时间到后自动关闭。该时间又配置文件规定。
* 按钮：按钮文字为“确定(X)”，X为关闭倒计时的秒数。按钮文字每隔1秒更新一次。

## 3 识别页

识别页的业务流程分为2个阶段，获取信息阶段和显示结果阶段。

### 3.1 获取信息阶段

获取信息分为4个步骤，分别为拍照-扫描图片-识别物品-识别垃圾

#### 3.1.1 拍照

<img src=page/识别页_拍照.png width=400px />

* 流程概述：打开摄像头，视频框内实时显示当前摄像头的拍摄到的内容范围，在合适的时机自动拍照，用作后续的图像处理材料，此图像以下简称为“照片”。
* 拍照时机：
  * 从显示图像到获得“照片”最短不少于3秒，最长不多于6秒。该时间由配置文件规定。
  * 在上述时间范围内，摄像头聚焦清晰时完成拍照动作。获得“照片”后，在视频框范围内显示照片，不再显示摄像头的图像，并关闭摄像头。
* 拍照完成后，进入识别物品阶段。
* 提示文字：“正在获取图像/p请将物品正对扫描窗口。”

#### 3.1.2 扫描图片

<img src=page/识别页_扫描.png width=400px />

* 流程概述：播放扫描特效，修改提示文字。
* 动效：播放半透明扫描特效，从照片顶部移动到照片底部，动效长度0.5秒。该时间长度由配置文件规定。
  * 扫描特效示意图如下：
  * <img src=media/scan.webp  width=400px/>
* 提示文字：“获取图像...完成/p正在扫描物品...”

#### 3.1.3 识别物品

<img src=page/识别页_定位.png width=400px />

* 流程概述：从照片中找到需要识别的物品。识别出物品的位置和范围，方便裁剪出对应的区域，以下简称为“物品图”，用于垃圾识别。
* 算法：调用外部api（百度、阿里云或其他的识别主体、元素识别算法）或自编识别算法
  * 物品图应排除背景、装饰、人像的干扰
  * 如果算法返回多个结果，从结果选取最符合的1个区域。
* 动效：将照片颜色调暗（或显示半透明黑色遮罩），根据物品的位置和尺寸，展示物品高亮范围，播放聚焦特效。
  * 聚焦特效示意图如下：
  * <img src=media/focus.gif  width=400px/>
* 提示文字：“扫描物品...完成/p正在分析类型...”

#### 3.1.4 识别垃圾
根据上述“物品图”，识别垃圾，获取对应的信息
* 算法：调用外部api完成（阿里云、聚合数据或其他）
* 获得返回数据后显示结果。

### 3.2 显示结果阶段

<img src=page/识别页_结果.png width=400px />

#### 3.2.1 信息录入

根据返回的垃圾信息填入垃圾名称、垃圾类型、处置方法，修改垃圾桶图片。

* 物品图：将 **3.1.3 识别物品** 阶段中的物品图保持比例缩放，最宽maxWidth像素，最高maxHeight像素。移动到页面中指定位置。
* 识别物品：填入返回结果的名称。
* 垃圾类型：根据返回结果的名称，本机所处的地理位置，结合城市垃圾类型配置表，显示相应的类型。表中无对应结果的，显示默认default内容。
* 处置建议：根据处置建议配置表，显示相应的文字内容。
* 垃圾桶图片：根据处置建议配置表，显示相应颜色的垃圾桶。
* 倒计时：文字内容为

#### 3.2.2 “再次识别”按钮

* 按钮状态：具有正常、按下两种状态。
* 点击逻辑：重新开始识别流程。

#### 3.2.3 倒计时文字
* 文字内容：“X秒后返回...”，X为秒数，初始值由配置文件决定。
* 倒计时完成动作：跳转到宣传页。

#### 3.2.4 跳转动效

从获取信息阶段到显示结果阶段，使用跳转动效。效果如下图：

<img src=media/result.gif width=400px />

#### 3.2.5 表结构示意

* 城市垃圾类型表结构如下（示意）：

  |城市|垃圾类型|类型名称|
  |----|----|----|
  |default|1|厨余垃圾|
  |上海|1|易腐垃圾| 
  |杭州|1|湿垃圾|
  |上海|2|干垃圾|
  |...|...|...|

* 处置建议表结构如下（示意）：

  |垃圾类型|建议|垃圾桶图片|
  |----|----|----|
  |1|1.做到“日产日清”；2.XXXXXX|trash_can_1.png|
  |2|XXXXXX|trash_can_2.png|
  |3|XXXXXX|trash_can_3.png|
  |4|XXXXXX|trash_can_4.png|
  |...|...|

### 3.3 动效与提示文字流程

整体APP动效流程可以参考以下链接的视频：

* **https://www.bilibili.com/video/BV1sY411n7u4/**

#### 3.3.1 流程描述

* 信息获取阶段，获取到“照片”后播放半透明扫描特效，从照片顶部移动到照片底部，动效长度0.5秒。扫描特效播放时，完成识别物品算法，获取物品的位置和尺寸。
* 扫描特效播放完成后，将照片颜色调暗（或显示半透明黑色遮罩），根据物品的位置和尺寸，展示物品高亮范围，播放聚焦特效。聚焦特效播放时，完成识别垃圾算法，获得垃圾信息。
* 聚焦特效完成后，进入结果展示阶段。移动物品图到指定位置，一次移入物品名称、垃圾类型、处置建议和垃圾桶图片。

#### 3.3.2 动效时间轴

时间轴的起始时间为 **3.1.1 拍照** 完成的时间。

|时间轴|播放特效|程序逻辑|
|----|----|----|
|0s-0.3s|无|识别物品|
|0.3-0.8s|扫描特效|等待|
|0.8-1.1s|无|等待|
|1.1-1.6s|图片变暗、聚焦特效|识别垃圾|
|1.6-2.6s|无|等待|
|2.6-2.9s|跳转特效|进入显示结果阶段|

### 3.4 免责文字

* 免责文字为一行小字，颜色稍淡，位于界面下侧。
* 文字内容：垃圾分类结果仅供参考，不作为垃圾投放依据。投放时请以当地相关部门发布的生活垃圾分类法律法规为准。